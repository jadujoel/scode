name: Make

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-latest-xlarge
    environment:
      name: scode
    steps:
    - uses: actions/checkout@v4
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
    - uses: actions-rs/cargo@v1
      with:
        command: build
        args: --release

    - name: codesign
      run: |
        echo $YOUR_NAME
        bash codesign.sh
      env:
        API_KEY_ID: ${{ secrets.API_KEY_ID }}
        API_KEY_ISSUER_ID: ${{ secrets.API_KEY_ISSUER_ID }}
        API_KEY_BASE64: ${{ secrets.API_KEY_BASE64 }}
        APP_NAME: ${{ secrets.APP_NAME }}
        BUNDLE_ID: ${{ secrets.BUNDLE_ID }}
        DEVELOPER_ID: ${{ secrets.DEVELOPER_ID }}
        P12_BASE64: ${{ secrets.P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
        YOUR_NAME: ${{ secrets.YOUR_NAME }}

    - uses: actions/upload-artifact@v4
      with:
        name: scode-macos
        path: target/release/scode.zip
